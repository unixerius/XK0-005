####################################
#
# Provision script for MySQL server.

$mysqlscript = <<-SCRIPT
# Install MariaDB, enable and start, plus open on the firewall.
yum install -y mariadb-server 
firewall-cmd --add-service=mysql --zone=public
firewall-cmd --add-service=mysql --zone=public --permanent
systemctl enable mariadb
systemctl start mariadb; sleep 10

# Create the database and user account for DVWA.
# MariaDB root password is <blank> by default, which is why this works. 
mysql -h localhost -u root << EOF
CREATE DATABASE dvwa;
CREATE USER dvwa@'%' IDENTIFIED BY 'password';
GRANT ALL ON dvwa.* TO dvwa@'%';
FLUSH PRIVILEGES;
EOF

# End of script.
SCRIPT

####################################
#
# Provision script for Apache server with DVWA.

$wwwscript = <<-SCRIPT
# Install Apache, MariaDB client and PHP plus modules
# Also open up the firewall.
yum install -y git mariadb httpd php php-mysqlnd php-gd 
firewall-cmd --add-service=http --zone=public
firewall-cmd --add-service=http --zone=public --permanent
firewall-cmd --add-service=https --zone=public
firewall-cmd --add-service=https --zone=public --permanent
firewall-cmd --reload

# Allow Apache to connect to MySQL on the network.
setsebool -P httpd_can_network_connect_db 1

# Copy the prepared php.ini from the synced dir. 
# This has prepared to allow dangerous options.
# We cannot use /vagrant, so I'll download this from my Github
#cp /vagrant/php.ini /etc/php.ini
curl -o /etc/php.ini https://raw.githubusercontent.com/unixerius/XK0-005/refs/heads/July2025/Lesson%20015%20-%20Troubleshooting%20network%20disk%20cpu/015-Vagrant-KVM-DVWA/php.ini


# Install DVWA from Github.
git clone https://github.com/digininja/DVWA.git /var/www/html

# Copy prepared DVWA config from the synced dir.
# We cannot use /vagrant, so I'll download this from my Github
#cp /vagrant/config.inc.php /var/www/html/config
curl -o /var/www/html/config/config.inc.php https://raw.githubusercontent.com/unixerius/XK0-005/refs/heads/July2025/Lesson%20015%20-%20Troubleshooting%20network%20disk%20cpu/015-Vagrant-KVM-DVWA/config.inc.php

# Set unsafe permissions on DVWA directories.
chown -R apache:apache /var/www/html
chmod -R 775 /var/www/html
chmod 777 /var/www/html/config

# Enable and start Apache
systemctl enable httpd
systemctl start httpd

# End of script.
SCRIPT


####################################
# 
# Vagrant main configuration, creating two VMs.
# Both VMs get /vagrant which is synced with this working dir. 
# The working dir contains the Vagrantfile, plus two
# prepared configuration files. 

Vagrant.configure("2") do |config|

  config.vm.box = "generic/centos8"

  config.vm.define :mysql do |mysql|
    mysql.vm.hostname = "mysql.haxor.corp"

    mysql.vm.synced_folder '.', '/vagrant', disabled: true
    mysql.vm.provider "libvirt" do |v|
      v.memory = 1024
      v.cpus = 1
    end
    mysql.vm.provision "setup", type: "shell", inline: $mysqlscript
  end

  config.vm.define :www do |www|
    www.vm.hostname = "www.haxor.corp"

    www.vm.synced_folder '.', '/vagrant', disabled: true
    www.vm.provider "libvirt" do |v|
      v.memory = 512
      v.cpus = 1
    end
    www.vm.provision "setup", type: "shell", inline: $wwwscript
  end

end


